<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Across the Stars</title>
    <link rel="icon" type="image/png" href="Img/estrella.webp">
    <link rel="stylesheet" href="style.css">
</head>

<body style="background-image: url('Img/BG4.png'); background-size: cover; background-repeat: no-repeat; background-attachment: fixed;">
    
    <!-- ğŸ‘¤ Usuario logueado -->
    <div id="user-profile">
        <img id="user-photo" src="" alt="Avatar">
        <span id="user-name">Usuario</span>
    </div>

    <!-- Pantalla inicial: Crear o Unirse -->
    <div id="initial-screen" class="lobby-container">
        <h1 class="lobby-title">ğŸŒŸ Multijugador</h1>
        <p class="waiting-message">Selecciona una opciÃ³n:</p>
        <div class="lobby-buttons">
            <button id="btn-create-room" class="btn-lobby btn-create">Crear Sala</button>
            <button id="btn-join-room" class="btn-lobby btn-join">Unirse a Sala</button>
        </div>
        <div class="lobby-buttons">
            <button id="btn-back" class="btn-lobby btn-leave">Volver al MenÃº</button>
        </div>
    </div>

    <!-- Pantalla de espera en sala -->
    <div id="waiting-screen" class="lobby-container hidden">
        <h1 class="lobby-title">ğŸ® Sala de Espera</h1>
        
        <div class="room-code">
            CÃ³digo: <span id="room-code">---</span>
        </div>

        <div class="player-list" id="player-list">
            <p class="waiting-message">Esperando jugadores...</p>
        </div>

        <div id="countdown-container" class="hidden">
            <p style="color: #fbbf24; font-size: 20px;">Â¡El juego comienza en:</p>
            <div class="countdown" id="countdown">3</div>
        </div>

        <div class="lobby-buttons">
            <button id="btn-ready" class="btn-lobby btn-ready">Â¡Listo!</button>
            <button id="btn-leave-room" class="btn-lobby btn-leave">Salir</button>
        </div>
    </div>

    <script type="module">
        import { auth, onAuthStateChanged, waitForAuth } from './scripts/config/firebase.js';
        import { RoomManager } from './scripts/systems/roomManager.js';

        const roomManager = new RoomManager();

        const initialScreen = document.getElementById('initial-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const playerList = document.getElementById('player-list');
        const roomCodeEl = document.getElementById('room-code');
        const countdownContainer = document.getElementById('countdown-container');
        const countdownEl = document.getElementById('countdown');
        const btnReady = document.getElementById('btn-ready');

        const userProfile = document.getElementById('user-profile');
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');

        // Verificar autenticaciÃ³n al cargar
        (async () => {
            const user = await waitForAuth();
            
            if (!user) {
                alert("âš ï¸ Debes iniciar sesiÃ³n primero");
                window.location.href = "index.html";
                return;
            }

            console.log("âœ… Usuario verificado:", user.displayName);
            
            // Mostrar perfil
            userProfile.style.display = "flex";
            userPhoto.src = user.photoURL || "Img/default-avatar.png";
            userName.textContent = user.displayName || "Usuario";
        })();

        // Crear sala
        document.getElementById('btn-create-room').addEventListener('click', async () => {
            try {
                const roomId = await roomManager.createRoom(3);
                showWaitingScreen(roomId);
            } catch (error) {
                console.error("Error creando sala:", error);
                alert("Error: " + error.message);
            }
        });

        // Unirse a sala
        document.getElementById('btn-join-room').addEventListener('click', async () => {
            try {
                const roomId = await roomManager.joinAvailableRoom();
                showWaitingScreen(roomId);
            } catch (error) {
                console.error("Error uniÃ©ndose:", error);
                alert("Error: " + error.message);
            }
        });

        // Marcar como listo
        btnReady.addEventListener('click', async () => {
            await roomManager.setReady(true);
            btnReady.disabled = true;
            btnReady.textContent = "âœ… Listo";
            btnReady.style.opacity = "0.6";
        });

        // Salir de sala
        document.getElementById('btn-leave-room').addEventListener('click', async () => {
            await roomManager.leaveRoom();
            location.reload();
        });

        // Volver al menÃº
        document.getElementById('btn-back').addEventListener('click', () => {
            window.location.href = "modoJ.html";
        });

        // Mostrar pantalla de espera
        function showWaitingScreen(roomId) {
            initialScreen.classList.add('hidden');
            waitingScreen.classList.remove('hidden');
            
            // Mostrar cÃ³digo corto de sala
            const shortCode = roomId.split('_')[1].slice(0, 6).toUpperCase();
            roomCodeEl.textContent = shortCode;
            
            console.log("ğŸ  En sala:", roomId);
        }

        // Actualizar lista de jugadores
        roomManager.onRoomUpdate = (roomData) => {
            const players = roomData.players || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                playerList.innerHTML = '<p class="waiting-message">Esperando jugadores...</p>';
                return;
            }

            playerList.innerHTML = Object.entries(players).map(([id, player]) => `
                <div class="player-item">
                    <div class="player-info">
                        <img src="${player.photoURL || 'Img/default-avatar.png'}" alt="${player.name}" class="player-avatar">
                        <span class="player-name">${player.name}</span>
                    </div>
                    <span class="ready-status ${player.ready ? 'ready-yes' : 'ready-no'}">
                        ${player.ready ? 'âœ“ Listo' : 'â³ Esperando'}
                    </span>
                </div>
            `).join('');

            console.log("ğŸ‘¥ Jugadores en sala:", playerCount);

            // Si el estado es "ready", mostrar cuenta regresiva
            if (roomData.status === 'ready') {
                showCountdown();
            }
        };

        // Cuenta regresiva
        function showCountdown() {
            countdownContainer.classList.remove('hidden');
            btnReady.style.display = "none";
            
            let count = 3;
            countdownEl.textContent = count;
            
            const interval = setInterval(() => {
                count--;
                
                if (count > 0) {
                    countdownEl.textContent = count;
                } else {
                    clearInterval(interval);
                    countdownEl.textContent = "Â¡GO!";
                }
            }, 1000);
        }

        // Iniciar juego
        roomManager.onGameStart = () => {
            console.log("ğŸš€ Â¡El juego comienza!");
            window.location.href = `jugar_multi.html?level=M&room=${roomManager.currentRoomId}`;
        };
    </script>
</body>
</html>